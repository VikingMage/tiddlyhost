services:
  web:
    image: nginx
    container_name: th_web
    restart: always
    depends_on:
    - prod
    ports:
    - "80:80"
    - "443:443"
    volumes:
    - ./docker/letsencrypt:/etc/letsencrypt:Z
    - ./docker/nginx-conf-prod:/etc/nginx/conf.d:Z

  prod:
    image: sbaird/tiddlyhost:latest
    container_name: th_app
    restart: always
    depends_on:
    - db
    - cache
    environment:
      RAILS_MASTER_KEY:

    volumes:
    - ./docker/log:/var/log/app:Z

    build:
      context: .
      dockerfile: docker/Dockerfile.prod

  cache:
    image: memcached
    container_name: th_cache
    command: memcached -I 8M

  db:
    image: postgres
    container_name: th_db
    restart: always
    environment:
      POSTGRES_PASSWORD: notsecure123
    volumes:
    - ./docker/postgresql-data/data:/var/lib/postgresql/data:Z
